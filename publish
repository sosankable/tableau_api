"""
é‡é»ç†è§£ï¼šåŸç”Ÿ REST API ç™¼ä½ˆ .twbx çš„é—œéµé»
ğŸ‘‰ REST API çš„ publish workbook æ–¹æ³•
POST /api/api-version/sites/site-id/workbooks?workbookType=twbx
é€™è£¡æœ‰å…©å€‹é—œéµé»ï¼š
"""

1. workbookType=twbx
é€™å€‹ä¸€å®šè¦åŠ ï¼Œè¡¨ç¤ºä½ å‚³ä¸Šä¾†çš„æ˜¯ Tableau Packaged Workbookï¼Œä¹Ÿå°±æ˜¯å…§å« Excelã€CSV ç­‰åµŒå…¥æª”æ¡ˆçš„æ ¼å¼ã€‚

å¦‚æœæ²’æŒ‡å®šï¼ŒTableau é è¨­æœƒç•¶æˆ .twbï¼Œé€™å°±æ˜¯ Excel ç‚ºä»€éº¼æ¶ˆå¤±çš„åŸå› ä¹‹ä¸€ï¼

2. multipart/form-data POST çµæ§‹
ä½ å¿…é ˆç™¼ä¸€å€‹ multipart/form-data çš„ POST è«‹æ±‚ï¼Œåˆ†ç‚ºå…©æ®µï¼š

Part 1 â€” XML metadata
é€™æ®µå®šç¾© workbook çš„è³‡è¨Šï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

<tsRequest>
  <workbook name="WorkbookName" showTabs="true">
    <project id="your_project_id" />
  </workbook>
</tsRequest>
Part 2 â€” binary file
é€™æ®µæ˜¯ä½ å¯¦éš›çš„ .twbx æª”æ¡ˆå…§å®¹ã€‚

æ­£ç¢ºåšæ³•ç¯„ä¾‹ï¼ˆç”¨åŸç”Ÿ REST API ä¸Šå‚³ .twbx ä¸¦åµŒå…¥ Excelï¼‰
ä»¥ä¸‹æ˜¯ä¸€å€‹ç´” Python ä½¿ç”¨ requests å¥—ä»¶ç™¼é€ multipart POST çš„ç¯„ä¾‹ï¼š

import requests

# Tableau Server B åƒæ•¸
server_url = "https://your-serverB.com"
api_version = "3.22"  # æ ¹æ“šä½ çš„ç‰ˆæœ¬èª¿æ•´
site_id = "your-site-id"  # å¦‚æœæ˜¯ default site å°±è¨­ ""
token_name = "your-token-name"
token_secret = "your-token-secret"
project_id = "your-project-id"
workbook_name = "yourWorkbook"
twbx_path = "path/to/yourWorkbook.twbx"

# ç™»å…¥å–å¾— token
auth_payload = {
    "credentials": {
        "personalAccessTokenName": token_name,
        "personalAccessTokenSecret": token_secret,
        "site": {
            "contentUrl": site_id
        }
    }
}
auth_res = requests.post(
    f"{server_url}/api/{api_version}/auth/signin",
    json=auth_payload
)
auth_data = auth_res.json()
token = auth_data['credentials']['token']
site_id = auth_data['credentials']['site']['id']

# æº–å‚™ multipart è¡¨å–®
boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW"

# Part 1: XML metadata
xml_payload = f"""
<tsRequest>
  <workbook name="{workbook_name}" showTabs="true">
    <project id="{project_id}" />
  </workbook>
</tsRequest>
"""

# è®€å…¥ .twbx æª”æ¡ˆ
with open(twbx_path, 'rb') as f:
    twbx_content = f.read()

# æº–å‚™ multipart æ ¼å¼
multipart_data = {
    'request_payload': (None, xml_payload, 'text/xml'),
    'tableau_workbook': (twbx_path, twbx_content, 'application/octet-stream'),
}

# ç™¼é€ Publish Workbook è«‹æ±‚
headers = {
    'X-Tableau-Auth': token
}

publish_url = f"{server_url}/api/{api_version}/sites/{site_id}/workbooks?workbookType=twbx&overwrite=true"

res = requests.post(publish_url, files=multipart_data, headers=headers)

print("Status Code:", res.status_code)
print("Response:", res.text)
